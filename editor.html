<!DOCTYPE html>

<html>
  <head>
    <title>editor</title>
<link rel="stylesheet" href="resources/codemirror.css">
<script src="resources/codemirror.js"></script>
<script src="resources/matchbrackets.js"></script>
<script src="resources/closebrackets.js"></script>
<script src="resources/scheme.js"></script>
    <style type="text/css">
      body { padding:0; margin: 0; font-family:courier, monospace; }
      pre { margin:0; }
      #repl { overflow-y:scroll;  }
      
      .editor, .repl { height:100vh; width:50%; float:left;  margin:0; padding: 0; background-color:#fff; border-width:0;}
      .editor { overflow-y:scroll; }
      .repl {  }

      .CodeMirror { height:100vh; width:50%; float:left; overflow-y:scroll; }
      .CodeMirror-matchingbracket {  border:1px solid #ccc; margin:-1px;  }
      .CodeMirror-nonmatchingbracket { border:1px solid #f00; margin:-1px; }

      .inputbox { white-space: pre-wrap; display:block; border:1px solid #ccc; min-height:1em; padding:2px 8px; }
      .result { white-space: pre-wrap; background-color: #eee; margin:0; padding: 2px 8px; }
      
      #dump_button {
         z-index:99;
         font-size:36pt;
         position:absolute; right:50%; margin-right:16px;
         background-color: #eee;
         border: 3px solid #ccc;
         padding:0 .4em;
         cursor:pointer;
      }
      #dump_button:hover { color:#fff;  }
    </style>
    <script type="text/javascript" src="base.js"></script>
    <script type="text/javascript" src="mk.js"></script>
    <script type="text/javascript" src="eval.js"></script>
    <script type="text/javascript" src="reader.js"></script>
  </head>
  <body onload="run()">


    <textarea id="editor" class="editor">
(define (five-six x)
  (conde
    ((== x 5))
    ((== x 6))
    ((five-six x))))

(define (membero x l)
 (fresh (head tail)
  (== l `(,head . ,tail))
  (conde
   ((== x head))
   ((membero x tail)))))

(define (appendo x y z)
 (conde
  ((== x '()) (== y z))
  ((fresh (head xtail ytail ztail)
    (== x `(,head . ,xtail))
    (== z `(,head . ,ztail))
    (appendo xtail y ztail)))))

(appendo left right '(1 2 3 4))
</textarea>
    <div id="dump_button">&#8658;</div>
    <div id="repl" class="repl"></div>
    <script type="text/javascript">
function run() {
     var options = { mode: "scheme",
                     matchBrackets: true,
                     autoCloseBrackets: true,
                     lineNumbers: true };
      var editor = CodeMirror.fromTextArea(document.getElementById("editor"), options);
      var repl = document.getElementById("repl");
      var current_input =  repl_getline();;
      
      function load_input(inputbox) {
      /* var textcontent = inputbox.innerHTML.replace(/<br(\s*)\/*>/ig, '\n') 
                                                         .replace(/<[p|div]\s/ig, '\n$0') 
                                                         .replace(/(<([^>]+)>)/ig, ""); */
                  var textcontent = inputbox.textContent;
                  try {
                      var generator = run_program(read_program(textcontent));
                      var result_elt = document.createElement("pre");
                      result_elt.className += "result";
                      var answer_text = document.createElement("pre");
                      var button = document.createElement("button");
                      var append_answer = function() { 
                         var result_val = generator();
                         if (result_val==null) { result_elt.removeChild(button); result_val = "No."; }
                         var result_val_pp = "Yes.\n" + result_val;
                         var result = document.createTextNode("=> " + result_val_pp + "\n");
                      
                         answer_text.appendChild(result);
                         button.focus();
                         button.scrollIntoView();
                         return false;
                      }
                      button.onclick = append_answer;
                      button.appendChild(document.createTextNode("More answers!"));

                      result_elt.appendChild(answer_text);
                      result_elt.appendChild(button);
                      append_answer();
                      repl.appendChild(result_elt);

                      inputbox.contentEditable = false;
                      repl_getline();
                      return false;
                  } catch (e) {
                      if(e instanceof ReaderError) {
                        inputbox.appendChild(document.createTextNode("\n"));
                        return true;
                      } else {
                        throw e;
                      }
                  }
        }

      function repl_getline() {
          var inputbox = document.createElement("pre");
          inputbox.className += "inputbox";
          inputbox.contentEditable = true;
          inputbox.onkeypress = function(e) {
              if (e.keyCode == 13) {
                  return load_input(inputbox);
              }
          };
          repl.appendChild(inputbox);
          inputbox.focus();
          inputbox.scrollIntoView();
          current_input = inputbox;
          return inputbox;
      }
      
      var dump_button = document.getElementById("dump_button");

      var load_editor = function() {
        var editor_value = editor.getValue();
        toplevel = new Object(null);
        current_input.textContent = editor_value;
        load_input(current_input);
        return false;
      }
      dump_button.onclick = load_editor;
}
</script>
  </body>
</html>
