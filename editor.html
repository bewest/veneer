<!DOCTYPE html>

<html>
  <head>
    <title>editor</title>
<link rel="stylesheet" href="resources/codemirror.css">
<script src="resources/codemirror.js"></script>
<script src="resources/matchbrackets.js"></script>
<script src="resources/closebrackets.js"></script>
<script src="resources/scheme.js"></script>
    <style type="text/css">
      body { padding:0; margin: 0; font-family:courier, monospace; height:100vh; background-color:#ccc }
      pre { margin:0; }

      #repl { overflow-y:scroll; }
      
      .repl { height:90%; width:50%; float:left;  margin:0; padding: 0; background-color:#f9f9f9; border-width:0;}
 
      .errors { position:absolute; top:.5em; left:.5em; z-index:100; width:46%;  margin:0; padding: 0 2%; background-color:transparent; border-width:0; }
      .error { background-color:#f00; color:#000; }

      .CodeMirror { height:90%; width:50%; float:left;}
      .CodeMirror-matchingbracket {  border:1px solid #ccc; margin:-1px;  }
      .CodeMirror-nonmatchingbracket { border:1px solid #f00; margin:-1px; }
      
      .inputbox:last-child { margin-bottom:1em;  }
      .inputbox { background-color:#fff; white-space: pre-wrap; display:block; border:1px solid #ccc; min-height:1em; padding:2px 8px; }
      .result { white-space: pre-wrap; background-color: #eee; margin:0; padding: 2px 8px; }
      
      #dump_button {
         z-index:99;
         font-size:36pt;
         position:absolute; right:50%; margin-right:16px;
         background-color: #eee;
         border: 3px solid #ccc;
         padding:0 .4em;
         cursor:pointer;
      }
      #dump_button:hover { color:#fff;  }
      
      #demos { display:none; }
    </style>
    <script type="text/javascript" src="base.js"></script>
    <script type="text/javascript" src="mk.js"></script>
    <script type="text/javascript" src="eval.js"></script>
    <script type="text/javascript" src="reader.js"></script>
  </head>
  <body onload="run()">
    <div id="errors" class="errors"></div>
<div id="head">
&nbsp;demos:<select id="demo_picker"></select>
&nbsp;saved files:<select id="localstorage_picker"></select>
<button id="new_file">create file</button>
<button id="save_file">save file</button></div>
<div id="demos">
<div class="demo">
<span class="title">reasoned schemer prelude</span>
<textarea class="content">
(define succeed (== #t #t))
(define fail (== #f #t))

(define caro
  (lambda (p a)
    (fresh (d)
      (== (cons a d) p))))

(define cdro
  (lambda (p d)
    (fresh (a)
      (== (cons a d) p))))

(define conso
  (lambda (a d p)
    (== (cons a d) p)))

(define nullo
  (lambda (x)
    (== '() x)))

(define eqo
  (lambda (x y)
    (== x y)))

(define eq-caro
  (lambda (l x)
    (caro l x)))

(define pairo
  (lambda (p)
    (fresh (a d)
      (conso a d p))))

(define listo
  (lambda (l)
    (conde
      ((nullo l) succeed)
      ((pairo l)
       (fresh (d)
         (cdro l d)
         (listo d))))))

(define membero
  (lambda (x l)
    (conde
      ((nullo l) fail)
      ((eq-caro l x) succeed)
      ((fresh (d)
          (cdro l d)
          (membero x d))))))

(define rembero  
  (lambda (x l out)
    (conde
      ((nullo l) (== '() out))
      ((eq-caro l x) (cdro l out))
      ((fresh (a d res)
              (conso a d l)
              (rembero x d res)
              (conso a res out))))))

(define appendo
  (lambda (l s out)
    (conde
      ((nullo l) (== s out))
      ((fresh (a d res)
          (conso a d l)
          (conso a res out)
          (appendo d s res))))))

(define anyo
  (lambda (g)
    (conde
      (g succeed)
      ((anyo g)))))

(define nevero (anyo fail))
(define alwayso (anyo succeed))


(define zeroo
  (lambda (n)
    (== '() n)))

(define poso
  (lambda (n)
    (fresh (a d)
      (== `(,a . ,d) n))))

(define >1o
  (lambda (n)
    (fresh (a ad dd)
      (== `(,a ,ad . ,dd) n))))

(define full-addero
  (lambda (b x y r c)
    (conde
      ((== 0 b) (== 0 x) (== 0 y) (== 0 r) (== 0 c))
      ((== 1 b) (== 0 x) (== 0 y) (== 1 r) (== 0 c))
      ((== 0 b) (== 1 x) (== 0 y) (== 1 r) (== 0 c))
      ((== 1 b) (== 1 x) (== 0 y) (== 0 r) (== 1 c))
      ((== 0 b) (== 0 x) (== 1 y) (== 1 r) (== 0 c))
      ((== 1 b) (== 0 x) (== 1 y) (== 0 r) (== 1 c))
      ((== 0 b) (== 1 x) (== 1 y) (== 0 r) (== 1 c))
      ((== 1 b) (== 1 x) (== 1 y) (== 1 r) (== 1 c)))))

(define addero
  (lambda (d n m r)
    (conde
      ((== 0 d) (== '() m) (== n r))
      ((== 0 d) (== '() n) (== m r)
       (poso m))
      ((== 1 d) (== '() m)
       (addero 0 n '(1) r))
      ((== 1 d) (== '() n) (poso m)
       (addero 0 '(1) m r))
      ((== '(1) n) (== '(1) m)
       (fresh (a c)
         (== `(,a ,c) r)
         (full-addero d 1 1 a c)))
      ((== '(1) n) (gen-addero d n m r))
      ((== '(1) m) (>1o n) (>1o r)
       (addero d '(1) n r))
      ((>1o n) (gen-addero d n m r)))))

(define gen-addero
  (lambda (d n m r)
    (fresh (a b c e x y z)
      (== `(,a . ,x) n)
      (== `(,b . ,y) m) (poso y)
      (== `(,c . ,z) r) (poso z)
      (full-addero d a b c e)
      (addero e x y z))))

(define pluso
  (lambda (n m k)
    (addero 0 n m k)))

(define minuso
  (lambda (n m k)
    (pluso m k n)))

(define *o
  (lambda (n m p)
    (conde
      ((== '() n) (== '() p))
      ((poso n) (== '() m) (== '() p))
      ((== '(1) n) (poso m) (== m p))
      ((>1o n) (== '(1) m) (== n p))
      ((fresh (x z)
         (== `(0 . ,x) n) (poso x)
         (== `(0 . ,z) p) (poso z)
         (>1o m)
         (*o x m z)))
      ((fresh (x y)
         (== `(1 . ,x) n) (poso x)
         (== `(0 . ,y) m) (poso y)
         (*o m n p)))
      ((fresh (x y)
         (== `(1 . ,x) n) (poso x)
         (== `(1 . ,y) m) (poso y)
         (odd-*o x n m p))))))

(define odd-*o
  (lambda (x n m p)
    (fresh (q)
      (bound-*o q p n m)
      (*o x m q)
      (pluso `(0 . ,q) m p))))

(define bound-*o
  (lambda (q p n m)
    (conde
      ((== '() q) (poso p))
      ((fresh (a0 a1 a2 a3 x y z)
         (== `(,a0 . ,x) q)
         (== `(,a1 . ,y) p)
         (conde
           ((== '() n)
            (== `(,a2 . ,z) m)
            (bound-*o x y z '()))
           ((== `(,a3 . ,z) n) 
            (bound-*o x y z m))))))))

(define =lo
  (lambda (n m)
    (conde
      ((== '() n) (== '() m))
      ((== '(1) n) (== '(1) m))
      ((fresh (a x b y)
         (== `(,a . ,x) n) (poso x)
         (== `(,b . ,y) m) (poso y)
         (=lo x y))))))

(define <lo
  (lambda (n m)
    (conde
      ((== '() n) (poso m))
      ((== '(1) n) (>1o m))
      ((fresh (a x b y)
         (== `(,a . ,x) n) (poso x)
         (== `(,b . ,y) m) (poso y)
         (<lo x y))))))

(define <=lo
  (lambda (n m)
    (conde
      ((=lo n m))
      ((<lo n m)))))

(define <o
  (lambda (n m)
    (conde
      ((<lo n m))
      ((=lo n m)
       (fresh (x)
         (poso x)
         (pluso n x m))))))

(define <=o
  (lambda (n m)
    (conde
      ((== n m))
      ((<o n m)))))

(define /o
  (lambda (n m q r)
    (conde
      ((== r n) (== '() q) (<o n m))
      ((== '(1) q) (=lo n m) (pluso r m n)
       (<o r m))
      ((<lo m n)
       (<o r m)
       (poso q)
       (fresh (nh nl qh ql qlm qlmr rr rh)
         (splito n r nl nh)
         (splito q r ql qh)
         (conde
           ((== '() nh)
            (== '() qh)
            (minuso nl r qlm)
            (*o ql m qlm))
           ((poso nh)
            (*o ql m qlm)
            (pluso qlm r qlmr)
            (minuso qlmr nl rr)
            (splito rr r '() rh)
            (/o nh m qh rh))))))))

(define splito
  (lambda (n r l h)
    (conde
      ((== '() n) (== '() h) (== '() l))
      ((fresh (b n^)
         (== `(0 ,b . ,n^) n)
         (== '() r)
         (== `(,b . ,n^) h)
         (== '() l)))
      ((fresh (n^)
         (==  `(1 . ,n^) n)
         (== '() r)
         (== n^ h)
         (== '(1) l)))
      ((fresh (b n^ a r^)
         (== `(0 ,b . ,n^) n)
         (== `(,a . ,r^) r)
         (== '() l)
         (splito `(,b . ,n^) r^ '() h)))
      ((fresh (n^ a r^)
         (== `(1 . ,n^) n)
         (== `(,a . ,r^) r)
         (== '(1) l)
         (splito n^ r^ '() h)))
      ((fresh (b n^ a r^ l^)
         (== `(,b . ,n^) n)
         (== `(,a . ,r^) r)
         (== `(,b . ,l^) l)
         (poso l^)
         (splito n^ r^ l^ h))))))

(define logo
  (lambda (n b q r)
    (conde
      ((== '(1) n) (poso b) (== '() q) (== '() r))
      ((== '() q) (<o n b) (pluso r '(1) n))
      ((== '(1) q) (>1o b) (=lo n b) (pluso r b n))
      ((== '(1) b) (poso q) (pluso r '(1) n))
      ((== '() b) (poso q) (== r n))
      ((== '(0 1) b)
       (fresh (a ad dd)
         (poso dd)
         (== `(,a ,ad . ,dd) n)
         (exp2 n '() q)
         (fresh (s)
           (splito n dd r s))))
      ((fresh (a ad add ddd)
         (conde
           ((== '(1 1) b))
           ((== `(,a ,ad ,add . ,ddd) b))))
       (<lo b n)
       (fresh (bw1 bw nw nw1 ql1 ql s)
         (exp2 b '() bw1)
         (pluso bw1 '(1) bw)
         (<lo q n)
         (fresh (q1 bwq1)
           (pluso q '(1) q1)
           (*o bw q1 bwq1)
           (<o nw1 bwq1))
         (exp2 n '() nw1)
         (pluso nw1 '(1) nw)
         (/o nw bw ql1 s)
         (pluso ql '(1) ql1)
         (<=lo ql q)
         (fresh (bql qh s qdh qd)
           (repeated-mul b ql bql)
           (/o nw bw1 qh s)
           (pluso ql qdh qh)
           (pluso ql qd q)
           (<=o qd qdh)
           (fresh (bqd bq1 bq)
             (repeated-mul b qd bqd)
             (*o bql bqd bq)
             (*o b bq bq1)
             (pluso bq r n)
             (<o n bq1))))))))

(define exp2
   (lambda (n b q)
     (conde
       ((== '(1) n) (== '() q))
       ((>1o n) (== '(1) q)
        (fresh (s)
          (splito n b s '(1))))
       ((fresh (q1 b2)
          (== `(0 . ,q1) q)
          (poso q1)
          (<lo b n)
          (appendo b `(1 . ,b) b2)
          (exp2 n b2 q1)))
       ((fresh (q1 nh b2 s)
          (== `(1 . ,q1) q)
          (poso q1)
          (poso nh)
          (splito n b s nh)
          (appendo b `(1 . ,b) b2)
          (exp2 nh b2 q1))))))

(define repeated-mul
  (lambda (n q nq)
    (conde
      ((poso n) (== '() q) (== '(1) nq))
      ((== '(1) q) (== n nq))
      ((>1o q)
       (fresh (q1 nq1)
         (pluso q1 '(1) q)
         (repeated-mul n q1 nq1)
         (*o nq1 n nq))))))

(define expo
  (lambda (b q n)
    (logo n b q '())))

(*o x y '(0 0 1 0 0 1 0 1 1))
</textarea>
</div>
<div class="demo">
<span class="title">lists</span>
<textarea class="content">
(define (membero x l)
 (fresh (head tail)
  (== l `(,head . ,tail))
  (conde
   ((== x head))
   ((membero x tail)))))

(membero x '(1 2 3))

(define (appendo x y z)
 (conde
  ((== x '()) (== y z))
  ((fresh (head xtail ytail ztail)
    (== x `(,head . ,xtail))
    (== z `(,head . ,ztail))
    (appendo xtail y ztail)))))

(appendo left right '(1 2 3 4))
</textarea>
</div>
<div class="demo">
<span class="title">grammar</span>
<textarea class="content">
(define (conso car cdr c) (== `(,car . ,cdr) c))

(define (membero x l)
 (fresh (head tail)
  (== l `(,head . ,tail))
  (conde
   ((== x head))
   ((membero x tail)))))

(define (nouno n) (membero n '(cat bat)))
(define (verbo v) (membero v '(eats)))
(define (deto d)  (membero d '(the a)))

;; fixed sentence structure
(define (my-sentenceo s)
  (fresh (v n1 d1 n2 d2)
    (verbo v)
    (nouno n1)
    (nouno n2)
    (deto d1)
    (deto d2)
    (== s `(,d1 ,n1 ,v ,d2 ,n2))))

(my-sentenceo x)

;; with parameterized structure
(define (wordo class word)
 (conde
  ((== class 'noun) (nouno word))
  ((== class 'verb) (verbo word))
  ((== class 'det)  (deto word))))

(define (sentenceo grammar s)
 (conde ((== grammar '()) (== s '()))
        ((fresh (g-head s-head
                 g-tail s-tail)
           (conso g-head g-tail grammar)
           (conso s-head s-tail s)
           (wordo g-head s-head)
           (sentenceo g-tail s-tail)))))

(sentenceo '(det noun verb det noun) s)
</textarea>
</div>
</div>
    <div id="dump_button">&#8658;</div>
    <div id="repl" class="repl"></div>
    <script type="text/javascript">
function run() {
     var errors = document.getElementById("errors");
     function display_error(e) {
        var error = document.createElement("div");
        var error_txt = document.createTextNode(e);
        error.className += "error";
        error.appendChild(error_txt);
        errors.appendChild(error);
        setTimeout(function() { errors.removeChild(error); }, 3000);
     }

     var options = { mode: "scheme",
                     matchBrackets: true,
                     autoCloseBrackets: true,
                     lineNumbers: true};
      var editor = false;
      var load_editor = function(ed) {
        document.body.insertBefore(ed, document.getElementById("repl"));
        return ed;
      };
      editor = new CodeMirror(load_editor, options);
      //editor.setSize("90%", "50%");
      var repl = document.getElementById("repl");
      var current_input =  repl_getline();;
      
      function load_input(inputbox) {
      /* var textcontent = inputbox.innerHTML.replace(/<br(\s*)\/*>/ig, '\n') 
                                                         .replace(/<[p|div]\s/ig, '\n$0') 
                                                         .replace(/(<([^>]+)>)/ig, ""); */
                  var textcontent = inputbox.textContent;
                  try {
                      var generator = run_program(read_program(textcontent));
                      var result_elt = document.createElement("pre");
                      result_elt.className += "result";
                      var answer_text = document.createElement("pre");
                      var button = document.createElement("button");
                      var append_answer = function() { 
                         var result_val = generator();
                         if (result_val==null) { result_elt.removeChild(button); result_val = "No."; }
                         var result_val_pp = "Yes.\n" + result_val;
                         var result = document.createTextNode("=> " + result_val_pp + "\n");
                      
                         answer_text.appendChild(result);
                         button.focus();
                         button.scrollIntoView();
                         return false;
                      }
                      button.onclick = append_answer;
                      button.appendChild(document.createTextNode("More answers!"));

                      result_elt.appendChild(answer_text);
                      result_elt.appendChild(button);
                      append_answer();
                      repl.appendChild(result_elt);

                      inputbox.contentEditable = false;
                      repl_getline();
                      return false;
                  } catch (e) {
                      if(e instanceof ReaderError) {
                        inputbox.appendChild(document.createTextNode("\n"));
                        display_error(e.msg);
                        return true;
                      } else {
                        display_error(e);
                        throw e;
                      }
                  }
        }

      function repl_getline() {
          var inputbox = document.createElement("pre");
          inputbox.className += "inputbox";
          inputbox.contentEditable = true;
          inputbox.onkeypress = function(e) {
              if (e.keyCode == 13) {
                  return load_input(inputbox);
              }
          };
          repl.appendChild(inputbox);
          inputbox.focus();
          inputbox.scrollIntoView();
          current_input = inputbox;
          return inputbox;
      }
      
      var dump_button = document.getElementById("dump_button");

      var load_editor = function() {
        var editor_value = editor.getValue();
        toplevel = new Object(null);
        current_input.textContent = editor_value;
        load_input(current_input);
        return false;
      }
      dump_button.onclick = load_editor;

      var loaded_file = false;
      function setEditorValue(val) {
         loaded_file = false;
         editor.setValue(val);
      }

      var demos = document.getElementsByClassName("demo");
      var demo_picker = document.getElementById("demo_picker");
      var file_values = new Array(demos.length);
      for(var i=0; i < demos.length; i++ ) {
          var selection = document.createElement("option");
          var name = demos[i].getElementsByClassName("title")[0].textContent;
          file_values[i] =  demos[i].getElementsByClassName("content")[0].value;
          selection.value = i;
          selection.appendChild(document.createTextNode(name));
          demo_picker.appendChild(selection);
      }
      demo_picker.onchange = function() { setEditorValue(file_values[demo_picker.selectedIndex]); };
      demo_picker.value = "0";
      setEditorValue(file_values[0]);

      var ls_picker = document.getElementById("localstorage_picker");
      var files = JSON.parse(localStorage.getItem('__index__') || "[]");
      for(var i=0; i < files.length; i++ ) {
          var selection = document.createElement("option");
          var name = files[i];
          selection.value = name;
          selection.appendChild(document.createTextNode(name));
          ls_picker.appendChild(selection);
      }
      ls_picker.onchange = function() {
         load_file(ls_picker[ls_picker.selectedIndex].value);
      };
     document.getElementById("save_file").onclick = save_current;
     document.getElementById("new_file").onclick = add_file;
      
      function load_file(name) {
          var new_val = localStorage.getItem(name);
          setEditorValue(new_val);
          loaded_file = name;
      }

      function confirm_overwrite(name) {
         return window.confirm("File exists: Are you sure you want to over-write  \"" + name + "\"");
      }
      function save_current() {
         if(loaded_file) {
           var overwrite = confirm_overwrite(loaded_file);
           if(!overwrite) { return false; }
         } else {
           loaded_file = window.prompt("save file as:","default");
           if(localStorage.getItem(loaded_file) && !confirm_overwrite(loaded_file)) {
             return false;
           }
         }
         if(files.indexOf(loaded_file) < 0) {
            files.push(loaded_file);

            var selection = document.createElement("option");
            selection.appendChild(document.createTextNode(loaded_file));
            ls_picker.appendChild(selection);
            ls_picker.value = loaded_file;
            localStorage.setItem('__index__', JSON.stringify(files));
         };
         localStorage.setItem(loaded_file, editor.getValue());
      } 

      function add_file() {
        save_current();
        setEditorValue('');
        save_current();
      }
      
       
}
</script>
  </body>
</html>
